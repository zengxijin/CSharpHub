<!DOCTYPE html>
<html>
    <head>
        <title>住院明细上传</title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <!-- Bootstrap -->
        <link rel="stylesheet" media="screen" href="css/bootstrap.min.css">
        <link rel="stylesheet" media="screen" href="css/bootstrap-theme.min.css">

        <!-- Bootstrap Admin Theme -->
        <link rel="stylesheet" media="screen" href="css/bootstrap-admin-theme.css">
        <link rel="stylesheet" media="screen" href="css/bootstrap-admin-theme-change-size.css">

        <!-- Custom styles -->
        <style type="text/css">
            @font-face {
                font-family: Ubuntu;
                src: url('fonts/Ubuntu-Regular.ttf');
            }
            .bs-docs-masthead{
                background-color: #6f5499;
                background-image: linear-gradient(to bottom, #563d7c 0px, #6f5499 100%);
                background-repeat: repeat-x;
            }
            .bs-docs-masthead{
                padding: 0;
            }
            .bs-docs-masthead h1{
                color: #fff;
                font-size: 40px;
                margin: 0;
                padding: 34px 0;
                text-align: center;
            }
            .bs-docs-masthead a:hover{
                text-decoration: none;
            }
            .meritoo-logo a{
                background-color: #fff;
                border: 1px solid rgba(66, 139, 202, 0.4);
                display: block;
                font-family: Ubuntu;
                padding: 22px 0;
                text-align: center;
            }
            .meritoo-logo a,
            .meritoo-logo a:hover,
            .meritoo-logo a:focus{
                text-decoration: none;
            }
            .meritoo-logo a img{
                display: block;
                margin: 0 auto;
            }
            .meritoo-logo a span{
                color: #4e4b4b;
                font-size: 18px;
            }
            .row-urls{
                margin-top: 4px;
            }
            .row-urls .col-md-6{
                text-align: center;
            }
            .row-urls .col-md-6 a{
                font-size: 14px;
            }
            #mask_background {position:absolute; z-index:998; top:0px; left:0px; background:rgb(50,50,50);background:rgba(0,0,0,0.5); display:none;}
            #mask_content {position:absolute; width:500px; z-index:999; padding:10px; background:#fff; border-radius:5px; display:none;}
        </style>

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
           <script type="text/javascript" src="js/html5shiv.js"></script>
           <script type="text/javascript" src="js/respond.min.js"></script>
        <![endif]-->
    </head>
<body class="bootstrap-admin-with-small-navbar" onload="checkLogin();">
    <div id="mask_background"></div>
    <div id="mask_content"></div>
    <!-- small navbar -->
    <nav class="navbar navbar-default navbar-fixed-top bootstrap-admin-navbar-sm" role="navigation">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="collapse navbar-collapse">
                        <ul class="nav navbar-nav navbar-left bootstrap-admin-theme-change-size">
                            <li style="float:left;">使用单位:<span id="loginInfo_DEP_NAME"></span></li>
                            <li style="float:left;padding-left:10px;">当前登录人:<span id="loginInfo_USER_CODE"></span></li>
                            <li style="float:left;padding-left:10px;">所在单位ID:<span id="loginInfo_DEP_ID"></span></li>
                            <li style="float:left;padding-left:10px;">当前时间:<span id="loginInfo_dateTime"></span></li>
                            <li><a class="size-changer large active" onclick="javascript: exit();">退出</a></li>
                        </ul>

                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- main / large navbar -->
    <nav class="navbar navbar-default navbar-fixed-top bootstrap-admin-navbar bootstrap-admin-navbar-under-small" role="navigation">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="navbar-header">
                        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".main-navbar-collapse">
                            <span class="sr-only">Toggle navigation</span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </button>

                    </div>
                    <div class="collapse navbar-collapse main-navbar-collapse">
                        <ul class="nav navbar-nav">
                            <li><a href="rydj.html">住院业务</a></li>
                            <li><a href="mzbc.html">门诊补偿</a></li>
                            <li class="active"><a href="zymxsc.html">住院费用上传</a></li>
                            <li><a href="czlp.html">发票打印</a></li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-hover="dropdown">其他 <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    <li role="presentation" class="dropdown-header">#1</li>
                                    <li><a href="xnhdz.html">新农合药品对照</a></li>

                                    <li role="presentation" class="divider"></li>
                                    <li role="presentation" class="dropdown-header">#2</li>
                                    <li><a href="#">菜单2</a></li>

                                </ul>
                            </li>
                        </ul>
                    </div><!-- /.navbar-collapse -->
                </div>
            </div>
        </div><!-- /.container -->
    </nav>

    <div class="container">

        <div class="row">
            <div class="col-lg-12">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <div class="text-muted bootstrap-admin-box-title">已登记未结算患者列表</div>
                    </div>

                        <div class="bootstrap-admin-panel-content">
                            <div class="form-inline" role="form">
                                <div class="form-group">
                                    <input type="text" class="form-control" id="queryBtn" placeholder="输入回车查询">
                                </div>
                            </div>
                            <p></p>
                            <table class="table table-striped table-bordered" id="zyls">
                                <thead>
                                    <tr>
                                        <th>姓名+住院号</th>
                                        <th>操作1</th>
                                        <th>操作2</th>
                                        <th>操作3</th>
                                        <th>批量操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                   

                                </tbody>
                            </table>
                        </div>
                    </div>
            </div>
        </div>

        <div>
            <button type="button" class="btn btn-default" id="batchUpload">批量传明细</button>
        </div>

        <p></p>
        

        <div class="row">
            <div class="col-lg-12">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <div class="text-muted bootstrap-admin-box-title">明细</div>
                    </div>
                    <div class="bootstrap-admin-panel-content">

                        <table class="table" id="zymx">
                            <thead>
                                <tr>
                                   <!--<th>住院号</th>-->
                                    <th>HIS项目编码</th>
                                    <th>项目名称</th>
                                    <th>项目单价</th>
                                    <th>项目数量</th>
                                    <th>项目总价格</th>
                                    <th>记账时间</th>
                                    <th>医嘱编号</th>
                                    <th>上传标志</th>
                                    <th>规格</th>
                                    <th>单位</th> 
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="mxlist"></tbody>
                        </table>
                        
                    </div>
                </div>
            </div>
        </div>

        <p></p>

    </div>

   

    <script type="text/javascript" src="js/jquery-2.0.3.min.js"></script>
    <script type="text/javascript" src="js/bootstrap.min.js"></script>
    <script type="text/javascript" src="js/twitter-bootstrap-hover-dropdown.min.js"></script>
    <script type="text/javascript" src="js/bootstrap-admin-theme-change-size.js"></script>
    <script type="text/javascript" src="js/jquery.cookie.js"></script>
    <script type="text/javascript" src="js/xnh.js"></script>
    <script type="text/javascript" src="js/jquery.base64.js"></script>
    <script>

        var buffer = null;
        //列表信息从HIS查，HIS提供接口
        //明细（也是从HIS取）
        //加个输入框筛选，字段由HIS定；
        $('#queryBtn').bind('keyup', function (event) {
            if (event.keyCode == "13") {
                var query = $("#queryBtn").val();
                if (query == '') {
                    alert("请输入信息查询");
                    return;
                }

                showMask("正在查询，请稍后...");
                //batchUpload
                $.ajax({
                    type: "Post",
                    url: "xnhservice.asmx/ydjwjs",
                    data: "{'query':'" + query + "'}",
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function (data) {
                        closeMask();
                        //返回的数据用data.d获取内容
                        var retVal = data.d;
                        //遍历json数组操作
                        var retJson = getJsonObj(retVal);
                        buffer = retJson;
                        if (retJson.flag == '0') {
                            var dataJson = buffer.msg.data;//buffer.msg.data[0]["NAME"]
                            $("#zyls tbody tr").detach();
                          
                            for (var i = 0; i < dataJson.length; i++) {
                                var row =
                                     '<tr class="odd gradeX">                               '
                                    + '    <td>' + dataJson[i]["NAME"] + '+' + dataJson[i]["IP_NO"] + '</td>                                        '
                                    + '    <td>                                             '
                                    + '        <a onclick="javascript:ddcmx(\'' + dataJson[i]["IP_NO"] + '\',\'' + dataJson[i]["REG_NO"] + '\');">单独传明细</a>                            '
                                    + '        <br />                                       '
                                    + '        <a>删除收费项目</a>                          '
                                    + '    </td>                                            '
                                    + '    <td class="center">                              '
                                    + '        <a>试算</a>                                  '
                                    + '        <br />                                       '
                                    + '        <a>结算收费</a>                              '
                                    + '    </td>                                            '
                                    + '    <td>                                             '
                                    + '        <button type="button" class="btn btn-default" onclick="javascript:ckmx(\'' + dataJson[i]["REG_NO"] + '\');">查看明细项目</button>                          '
                                    + '        <br />                                       '
                                    + '        <a></a>                                      '
                                    + '    </td>                                            '
                                    + '    <td>                                             '
                                    + '    <input type="checkbox" value="' + dataJson[i]["IP_NO"] + '" />  '
                                    + '     </td>                                           '
                                    + '</tr>                                                '
                                $("#zyls tbody").append(row);
                            }
                            
                            
                                
                        } else {
                            alert("查询失败：" + retJson.msg);
                        }

                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        closeMask();
                        alert(textStatus + ":" + errorThrown);
                    }
                });
            }
        });

        //批量传明细按钮
        $("#batchUpload").on("click", function () {
            var count = 0;
            var checkedVal = "";
            //获取选中的项
            $('input:checkbox').each(function () {
                if ($(this).prop('checked') == true) {
                    count++;
                    checkedVal += $(this).val() + "$";
                }
            });

            if (count == 0) {
                alert("请选择项目上传");
                return;
            } else {
                //alert("共选者了" + count + "个，" + checkedVal);
                if (confirm("您共选中了" + count + "条记录，确定上传？")) {
                    showMask("正在处理，请稍后...");
                    $.ajax({
                        type: "Post",
                        url: "xnhservice.asmx/plcmx",
                        data: "{'data':'" + checkedVal + "'}",
                        contentType: "application/json; charset=utf-8",
                        dataType: "json",
                        success: function (data) {
                            closeMask();
                            //返回的数据用data.d获取内容
                            var retVal = data.d;
                            //遍历json数组操作
                            var retJson = getJsonObj(retVal);
                            if (retJson.flag == '0') {
                                var json = retJson.msg;

                                //todo：根据需要绑定解析和绑定前台数据

                            } else {
                                alert("上传失败：" + retJson.msg);
                            }

                        },
                        error: function (XMLHttpRequest, textStatus, errorThrown) {
                            closeMask();
                            alert(textStatus + ":" + errorThrown);
                        }
                    });
                }
            }
        });

        ///查看明细项目
        function ckmx(REG_NO) {  

            var checkedVal = REG_NO;   //把住院流水号放进去
            showMask("正在处理，请稍后...");
            $.ajax({
                type: "Post",
                url: "xnhservice.asmx/zymxcx",
                data: "{'data':'" + checkedVal + "'}",
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (data) {
                    closeMask();
                    //返回的数据用data.d获取内容
                    var retVal = data.d;
                    //遍历json数组操作
                    var retJson = getJsonObj(retVal);
                    if (retJson.flag == '0') {
                        var row = retJson.msg.data[0];
                        
                        $("#zymx tbody tr").detach();
                        

                        var trId = $.trim(row['IP_NO']);

                        var trStr = '<tr class="example" id="' + trId + '" >';//动态拼接table

                        //trStr += '<td id="' + trId + '_ip_no">' + $.trim(row['IP_NO']) + '</td>';//数据表的主键值 门诊流水号
                        trStr += '<td id="' + trId + '_item_code">' + row['ITEM_CODE'] + '</td>';    //项目编码
                        trStr += '<td id="' + trId + '_item_name">' + row['ITEM_NAME'] + '</td>';  //名称
                        trStr += '<td id="' + trId + '_price">' + row['PRICE'] + '</td>';   //项目单价
                        trStr += '<td id="' + trId + '_qty">' + row['QTY'] + '</td>';         //项目数量
                        trStr += '<td id="' + trId + '_total">' + row['TOTAL'] + '</td>'; //项目总价格
                        trStr += '<td id="' + trId + '_bill_time">' + row['BILL_TIME'] + '</td>'; //记账时间
                        trStr += '<td id="' + trId + '_pre_no">' + row['PRE_NO'] + '</td>';         //医嘱编号
                        trStr += '<td id="' + trId + '_up_flag">' + row['UP_FLAG'] + '</td>'; //上传标志
                        trStr += '<td id="' + trId + '_standard">' + row['STANDARD'] + '</td>';//规格
                        trStr += '<td id="' + trId + '_small_unit">' + row['SMALL_UNIT'] + '</td>';//单位
                        trStr += '<td class="center">                              '
                        + '        <a onclick="javascript:zfsfxm(\'' + row['IP_NO'] + '\',\'' + row["NH_BM"] + '\');" >作废收费项目</a>                                  '
                        + '    </td> ';
                        $(trStr).appendTo("#mxlist");
                        
                        //todo：根据需要绑定解析和绑定前台数据

                    } else {
                        alert("查询失败：" + retJson.msg);
                    }

                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    closeMask();
                    alert(textStatus + ":" + errorThrown);
                }
            });

        }
    
        //作废收费项目
        function zfsfxm(D504_09, NH_BM) {
            if (confirm("确定作废收费项目？")) {
            } else {
                return;
            }

            var USER_ID = getCookie("USER_ID");
            var pMap = {};
            pMap["USER_ID"] = USER_ID;
            pMap["D504_09"] = D504_09; //住院号
            pMap["NH_BM"] = NH_BM; //住院号
            var pJson = map2Json(pMap);

            showMask("正在处理，请稍后...");
            $.ajax({
                type: "Post",
                url: "xnhservice.asmx/zfsfxm",
                data: pJson,
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (data) {
                    closeMask();
                    var retVal = data.d;
                    //遍历json数组操作
                    var retJson = getJsonObj(retVal);
                    if (retJson.flag == '0') {
                        alert("处理成功");
                    } else {
                        alert("处理失败：" + retJson.msg);
                    }

                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    closeMask();
                    alert(textStatus + ":" + errorThrown);
                }
            });

        }
    
        //单独传明细
        function ddcmx(IP_NO, REG_NO) {
            //D505_02	入院登记成功后返回的住院登记流水号
            //COME_AREA	登录返回的
            //AREA_CODE	存储的病人地区编码
            //D505_04	住院明细sql查询里面的item_code（收费项目编码组合   （药品代码、数量、单价））
            //D505_08	住院明细sql查询里面的qty
            //D505_07	住院明细sql查询里面的price
            //D505_09	（农合技术部说是保内是1 保外是0）
            //D505_ID_HIS	农合编码
            //USER_ID	登录返回的
            //D504_14	取用户登录后返回的诊治单位代码
            //USER_NAME	取用户登录后返回的操作员姓名
            //LEVEL	取用户登录后返回的DEP_LEVEL
            if (confirm("确定上传 " + IP_NO + " 明细？")) {
            } else {
                return;
            }

            var USER_ID = getCookie("USER_ID");
            var pMap = {};
            pMap["USER_ID"] = USER_ID; //当前操作员id
            pMap["COME_AREA"] = getCookie("DEP_AREA"); //地区代码(医疗机构)
            pMap["D504_14"] = getCookie("DEP_ID"); //诊治单位代码
            pMap["D504_09"] = IP_NO; //住院号
            pMap["USER_NAME"] = getCookie("USER_NAME"); //操作员姓名
            pMap["LEVEL"] = getCookie("DEP_LEVEL"); //诊治单位级别
            pMap["REG_NO"] = REG_NO; //住院流水
            var paramBase64 = $.base64.encode(map2Json(pMap), "utf8"); //base64编码，防止传到后台乱码

            var newMap = {};
            newMap["PARAM"] = paramBase64; 
            var pJson = map2Json(newMap);

            showMask("正在处理，请稍后...");
            $.ajax({
                type: "Post",
                url: "xnhservice.asmx/ddcmx",
                data: pJson,
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (data) {
                    closeMask();
                    var retVal = data.d;
                    //遍历json数组操作
                    var retJson = getJsonObj(retVal);
                    if (retJson.flag == '0') {
                        alert("处理成功");
                    } else {
                        alert("处理失败：" + retJson.msg);
                    }

                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    closeMask();
                    alert(textStatus + ":" + errorThrown);
                }
            });

        }
    
    </script>
</body>

</html>
