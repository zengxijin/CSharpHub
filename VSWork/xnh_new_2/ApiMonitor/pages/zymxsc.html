<!DOCTYPE html>
<html>
    <head>
        <title>住院明细上传</title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <!-- Bootstrap -->
        <link rel="stylesheet" media="screen" href="css/bootstrap.min.css">
        <link rel="stylesheet" media="screen" href="css/bootstrap-theme.min.css">

        <!-- Bootstrap Admin Theme -->
        <link rel="stylesheet" media="screen" href="css/bootstrap-admin-theme.css">
        <link rel="stylesheet" media="screen" href="css/bootstrap-admin-theme-change-size.css">

        <!-- Custom styles -->
        <style type="text/css">
            @font-face {
                font-family: Ubuntu;
                src: url('fonts/Ubuntu-Regular.ttf');
            }
            .bs-docs-masthead{
                background-color: #6f5499;
                background-image: linear-gradient(to bottom, #563d7c 0px, #6f5499 100%);
                background-repeat: repeat-x;
            }
            .bs-docs-masthead{
                padding: 0;
            }
            .bs-docs-masthead h1{
                color: #fff;
                font-size: 40px;
                margin: 0;
                padding: 34px 0;
                text-align: center;
            }
            .bs-docs-masthead a:hover{
                text-decoration: none;
            }
            .meritoo-logo a{
                background-color: #fff;
                border: 1px solid rgba(66, 139, 202, 0.4);
                display: block;
                font-family: Ubuntu;
                padding: 22px 0;
                text-align: center;
            }
            .meritoo-logo a,
            .meritoo-logo a:hover,
            .meritoo-logo a:focus{
                text-decoration: none;
            }
            .meritoo-logo a img{
                display: block;
                margin: 0 auto;
            }
            .meritoo-logo a span{
                color: #4e4b4b;
                font-size: 18px;
            }
            .row-urls{
                margin-top: 4px;
            }
            .row-urls .col-md-6{
                text-align: center;
            }
            .row-urls .col-md-6 a{
                font-size: 14px;
            }
            #mask_background {position:absolute; z-index:998; top:0px; left:0px; background:rgb(50,50,50);background:rgba(0,0,0,0.5); display:none;}
            #mask_content {position:absolute; width:500px; z-index:999; padding:10px; background:#fff; border-radius:5px; display:none;}
        </style>

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
           <script type="text/javascript" src="js/html5shiv.js"></script>
           <script type="text/javascript" src="js/respond.min.js"></script>
        <![endif]-->
    </head>
<body class="bootstrap-admin-with-small-navbar" onload="checkLogin();">
    <div id="mask_background"></div>
    <div id="mask_content"></div>
    <!-- small navbar -->
    <nav class="navbar navbar-default navbar-fixed-top bootstrap-admin-navbar-sm" role="navigation">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="collapse navbar-collapse">
                        <ul class="nav navbar-nav navbar-left bootstrap-admin-theme-change-size">
                            <li style="float:left;">使用单位:<span id="loginInfo_DEP_NAME"></span></li>
                            <li style="float:left;padding-left:10px;">当前登录人:<span id="loginInfo_USER_CODE"></span></li>
                            <li style="float:left;padding-left:10px;">所在单位ID:<span id="loginInfo_DEP_ID"></span></li>
                            <li style="float:left;padding-left:10px;">当前时间:<span id="loginInfo_dateTime"></span></li>
                            <li><a class="size-changer large active" onclick="javascript: exit();">退出</a></li>
                        </ul>

                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- main / large navbar -->
    <nav class="navbar navbar-default navbar-fixed-top bootstrap-admin-navbar bootstrap-admin-navbar-under-small" role="navigation">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="navbar-header">
                        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".main-navbar-collapse">
                            <span class="sr-only">Toggle navigation</span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </button>

                    </div>
                    <div class="collapse navbar-collapse main-navbar-collapse">
                        <ul class="nav navbar-nav">
                            <li><a href="rydj.html">住院业务</a></li>
                            <li><a href="mzbc.html">门诊补偿</a></li>
                            <li class="active"><a href="zymxsc.html">住院费用上传</a></li>
                            <li><a href="czlp.html">发票打印</a></li>
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-hover="dropdown">其他 <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    <li role="presentation" class="dropdown-header">#1</li>
                                    <li><a href="#">菜单1</a></li>

                                    <li role="presentation" class="divider"></li>
                                    <li role="presentation" class="dropdown-header">#2</li>
                                    <li><a href="#">菜单2</a></li>

                                </ul>
                            </li>
                        </ul>
                    </div><!-- /.navbar-collapse -->
                </div>
            </div>
        </div><!-- /.container -->
    </nav>

    <div class="container">

        <div class="row">
            <div class="col-lg-12">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <div class="text-muted bootstrap-admin-box-title">已登记未结算患者列表</div>
                    </div>

                        <div class="bootstrap-admin-panel-content">
                            <div class="form-inline" role="form">
                                <div class="form-group">
                                    <input type="text" class="form-control" id="queryBtn" placeholder="输入回车查询">
                                </div>
                            </div>
                            <p></p>
                            <table class="table table-striped table-bordered" id="zyls">
                                <thead>
                                    <tr>
                                        <th>姓名+住院号</th>
                                        <th>操作1</th>
                                        <th>操作2</th>
                                        <th>操作3</th>
                                        <th>批量操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                   

                                </tbody>
                            </table>
                        </div>
                    </div>
            </div>
        </div>

        <div>
            <button type="button" class="btn btn-default" id="batchUpload">批量传明细</button>
        </div>

        <p></p>
        

        <div class="row">
            <div class="col-lg-12">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <div class="text-muted bootstrap-admin-box-title">明细</div>
                    </div>
                    <div class="bootstrap-admin-panel-content">

                        <table class="table" id="zymx">
                            <thead>
                                <tr>
                                    <th>HIS项目编码</th>
                                    <th>项目名称</th>
                                    <th>项目单价</th>
                                    <th>项目数量</th>
                                    <th>项目总价格</th>
                                    <th>记账时间</th>
                                    <th>医嘱编号</th>
                                    <th>上传标志</th>
                                    <th>规格</th>
                                    <th>单位</th> 
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="mxlist"></tbody>
                        </table>
                        <!--<table class="table">
                            <tbody>-->
                                <!--<tr>
                    <td>登录名：刘德华</td>
                    <td>所在单位ID：xxxx</td>
                    <td>电话：123456789</td>
                    <td>单位名称：4564687631xxadas</td>
                </tr>-->
                                <!--<tr>
                    <td>机构详细地址编码：1235</td>
                    <td>机构类型：乡</td>
                    <td>机构级别：村卫生室</td>
                    <td>机构地区编码：5464</td>
                </tr>
                <tr>
                    <td>补偿年度：2016</td>
                    <td>本县芯片卡刷卡授权：有刷卡权限</td>
                    <td>本县刷卡标志是够开启：开启</td>
                    <td>此医疗机构刷卡权限是否开启：刷</td>
                </tr>
                <tr>
                    <td>是否开启药品最高限价：开启</td>
                    <td>日记账药品删除期限：22</td>
                    <td>本县保障起始时间：2016-10-10</td>
                    <td>本县保障结束时间：2016-12-10</td>

                </tr>
                <tr>
                    <td>打印明细是否汇总：汇总</td>
                    <td>是否启用单次刷卡时间限制：不启用</td>
                    <td>单次刷卡时间：10</td>
                    <td></td>
                </tr>-->
                            <!--</tbody>
                        </table>-->
                    </div>
                </div>
            </div>
        </div>

        <p></p>

    </div>

   

    <script type="text/javascript" src="js/jquery-2.0.3.min.js"></script>
    <script type="text/javascript" src="js/bootstrap.min.js"></script>
    <script type="text/javascript" src="js/twitter-bootstrap-hover-dropdown.min.js"></script>
    <script type="text/javascript" src="js/bootstrap-admin-theme-change-size.js"></script>
    <script type="text/javascript" src="js/jquery.cookie.js"></script>
    <script type="text/javascript" src="js/xnh.js"></script>
    <script type="text/javascript" src="js/jquery.base64.js"></script>
    <script>

        var buffer = null;
        //列表信息从HIS查，HIS提供接口
        //明细（也是从HIS取）
        //加个输入框筛选，字段由HIS定；
        $('#queryBtn').bind('keyup', function (event) {
            if (event.keyCode == "13") {
                var query = $("#queryBtn").val();
                if (query == '') {
                    alert("请输入信息查询");
                    return;
                }

                showMask("正在查询，请稍后...");
                //batchUpload
                $.ajax({
                    type: "Post",
                    url: "xnhservice.asmx/ydjwjs",
                    data: "{'query':'" + query + "'}",
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function (data) {
                        closeMask();
                        //返回的数据用data.d获取内容
                        var retVal = data.d;
                        //遍历json数组操作
                        var retJson = getJsonObj(retVal);
                        buffer = retJson;
                        if (retJson.flag == '0') {
                            var dataJson = buffer.msg.data;//buffer.msg.data[0]["NAME"]
                            $("#zyls tbody tr").detach();
                          
                            for (var i = 0; i < dataJson.length; i++) {
                                var row =
                                     '<tr class="odd gradeX">                               '
                                    + '    <td>' + dataJson[i]["NAME"] + '+' + dataJson[i]["IP_NO"] + '</td>                                        '
                                    + '    <td>                                             '
                                    + '        <a>单独传明细</a>                            '
                                    + '        <br />                                       '
                                    + '        <a>删除收费项目</a>                          '
                                    + '    </td>                                            '
                                    + '    <td class="center">                              '
                                    + '        <a>试算</a>                                  '
                                    + '        <br />                                       '
                                    + '        <a>结算收费</a>                              '
                                    + '    </td>                                            '
                                    + '    <td>                                             '
                                    + '        <button type="button" class="btn btn-default" onclick="javascript:ckmx(\'' + dataJson[i]["REG_NO"] + '\');">查看明细项目</button>                          '
                                    + '        <br />                                       '
                                    + '        <a></a>                                      '
                                    + '    </td>                                            '
                                    + '    <td>                                             '
                                    + '    <input type="checkbox" value="刘德华 562148" />  '
                                    + '     </td>                                           '
                                    + '</tr>                                                '
                                $("#zyls tbody").append(row);
                            }
                            
                            
                                
                        } else {
                            alert("查询失败：" + retJson.msg);
                        }

                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        closeMask();
                        alert(textStatus + ":" + errorThrown);
                    }
                });
            }
        });

        //批量传明细按钮
        $("#batchUpload").on("click", function () {
            var count = 0;
            var checkedVal = "";
            //获取选中的项
            $('input:checkbox').each(function () {
                if ($(this).prop('checked') == true) {
                    count++;
                    checkedVal += $(this).val() + "$";
                }
            });

            if (count == 0) {
                alert("请选择项目上传");
                return;
            } else {
                //alert("共选者了" + count + "个，" + checkedVal);
                if (confirm("您共选中了" + count + "条记录，确定上传？")) {
                    showMask("正在处理，请稍后...");
                    $.ajax({
                        type: "Post",
                        url: "xnhservice.asmx/plcmx",
                        data: "{'data':'" + checkedVal + "'}",
                        contentType: "application/json; charset=utf-8",
                        dataType: "json",
                        success: function (data) {
                            closeMask();
                            //返回的数据用data.d获取内容
                            var retVal = data.d;
                            //遍历json数组操作
                            var retJson = getJsonObj(retVal);
                            if (retJson.flag == '0') {
                                var json = retJson.msg;

                                //todo：根据需要绑定解析和绑定前台数据

                            } else {
                                alert("上传失败：" + retJson.msg);
                            }

                        },
                        error: function (XMLHttpRequest, textStatus, errorThrown) {
                            closeMask();
                            alert(textStatus + ":" + errorThrown);
                        }
                    });
                }
            }
        });

        ///查看明细项目
        function ckmx(REG_NO) {  //按钮触发不了？

            var checkedVal = REG_NO;   //怎么把住院流水号放进去？ 
            showMask("正在处理，请稍后...");
            $.ajax({
                type: "Post",
                url: "xnhservice.asmx/zymxcx",
                data: "{'data':'" + checkedVal + "'}",
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (data) {
                    closeMask();
                    //返回的数据用data.d获取内容
                    var retVal = data.d;
                    //遍历json数组操作
                    var retJson = getJsonObj(retVal);
                    if (retJson.flag == '0') {
                        var json = retJson.msg;
                        $("#zymx tbody tr").detach();
                        for (var item in json.data) {
                            var row = json.data[item];

                            var trId = $.trim(row['REC_NO']);

                            var trStr = '<tr class="example" id="' + trId + '" >';//动态拼接table
                            // var html = '';
                            //for (var key in row) {//
                            trStr += '<td id="' + trId + '_item_code">' + $.trim(row['item_code']) + '</td>';//数据表的主键值 门诊流水号
                            //}
                            trStr += '<td id="' + trId + '_item_code">' + row['item_code'] + '</td>';    //项目编码
                            trStr += '<td id="' + trId + '_item_name">' + row['item_name'] + '</td>';  //名称
                            trStr += '<td id="' + trId + '_price">' + row['price'] + '</td>';   //项目单价
                            trStr += '<td id="' + trId + '_qty">' + row['qty'] + '</td>';         //项目数量
                            trStr += '<td id="' + trId + '_total">' + row['total'] + '</td>'; //项目总价格
                            trStr += '<td id="' + trId + '_bill_time">' + row['bill_time'] + '</td>'; //记账时间
                            trStr += '<td id="' + trId + '_pre_no">' + row['pre_no'] + '</td>';         //医嘱编号
                            trStr += '<td id="' + trId + '_up_flag">' + row['up_flag'] + '</td>'; //上传标志
                            trStr += '<td id="' + trId + '_standard">' + row['standard'] + '</td>';//规格
                            trStr += '<td id="' + trId + '_small_unit">' + row['small_unit'] + '</td>';//单位
                            trStr += '<td class="center">                              '
                            + '        <a>作废收费项目</a>                                  '
                            + '    </td> ';
                            $(trStr).appendTo("#mxlist");
                        }
                        //todo：根据需要绑定解析和绑定前台数据

                    } else {
                        alert("查询失败：" + retJson.msg);
                    }

                },
                error: function (XMLHttpRequest, textStatus, errorThrown) {
                    closeMask();
                    alert(textStatus + ":" + errorThrown);
                }
            });

        }
    </script>
</body>

</html>
